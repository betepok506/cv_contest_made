# Описание 
Данный репозиторий содержит модели классификации для CV 
[контеста](https://www.kaggle.com/competitions/vk-made-sports-image-classification/overview)
Было проведена серия экспериментов с моделями ResNet50, ResNet101, Swin результаты обучения представлены ниже в таблице.

Веса для моделей: [Гугл диск с весами моделей](https://drive.google.com/drive/folders/1vrx6XjZOdMcLQGimxF7DAkmP5g4K0a8v?usp=sharing)

# Установка

Сначала необходимо установить `torch` gpu нужной вам версии cuda. Если не планируете ипользовать gpu смело пропускайте этот шаг
```commandline
pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

Далее для установки зависимостей выполните команду:
```commandline
pip install -r requirements.txt
```
# Запуск
Конфигурирование производится с помощью конфигов в каталоге `configs`.

*Лучше всего запускать скрипты из корневой дирректории.*

Назначения конфигурационных файлов:
- `predict_params.yaml` --- конфигурационный файл для запуска пайплайна предсказания;
- `train_config.yaml` --- конфигурационный файл для запуска пайплайна обучения;
- `splitting_config.yaml` --- конфигурационный файл с параметрами для разделения датасета на test и valid.

## Подготовка данных
Перед обучением необходимо разделить набора данных на обучеющую и валидационную выборки. 
Для этого необходимо воспользоваться скриптом `scr/split_dataset`, 
предварительно настроив параметра в конфигурационном файле

Параметры:
- path_to_dataset --- Путь до датасета 
- test_size --- Доля тестового набора 
- name_file --- CSV файл, содержащий имена файлов

Файлы, содержащие обучающий и валидационной наборы будут созданы в дирректории датасета 
с именами `train_.csv` и `valid_.csv` соответственно.


## Обучение
Для запуска `src/train` необходимо настроить следующие параметры:

 - path_to_classes --- JSON-файл, содержащий кодирование классов в числовые значения меток (По умолчанию находится в `data/encode_classes.json`)
 - path_to_weights --- Путь до модели, веса которой необходимо загрузить (Для дообучения)
 - path_to_dataset --- Путь до датасета

Параметр `path_save_checkpoint` изменять не нужно. Модели сохряняются в каталог с логами, а именно: `./runs/<cur datetime>/models`.

*Остальные параметры могут изменяться по желанию*

## Предсказание
Перед запуском `src/predict` необходимо настроить следующие параметры:
- path_to_classes --- JSON-файл, содержащий кодирование классов в числовые значения меток (По умолчанию находится в `data/encode_classes.json`)
- path_to_weights --- Путь до модели, веса которой необходимо загрузить
- path_to_dataset --- Путь до датасета
- name_model --- Наименование архитектуры используемой при обучении
- path_to_save_result --- Путь сохранения результата классификации в виде csv файла
- visualize_result --- Параметр для копирования изображений в папку соответствующую результату классификации (Исключительно для визуальной оценки результатов классификации). Если True то сохраняем результат, иначе False
- path_to_save_images ---  Каталог для сохранения изображений из предыдущего параметра

*Остальные параметры могут изменяться по желанию*


## Просмотр процесса обучения
Процесс обучения логируется с помощью `tensorboard`. Для его просмотра необходимо выполнить команду:
```commandline
tensorboard --logdir=<folder "runs">
```
<folder "runs"> --- Каталог с логами. По находится в папке запуска `train`.


# Таблица результатов

 Модель   | Epoch | Image size | Train F1 Score | Validate F1 Score | Test F1 Score | Ссылка на веса                                                                               
----------|-------|------------|---------------|------------------|---------------|----------------------------------------------------------------------------------------------|
ResNet50 | 90    | (224, 224) | 0.7362        | 0.7789           | -             | [Ссылка](https://drive.google.com/file/d/1c0sGjMgnNyNZaDI5CRaUqwdv0GDd7MRj/view?usp=sharing)                                                                                   |
ResNet101 | 90    | (224, 224) | 0.7668        | 0.7803           | -             | [Ссылка](https://drive.google.com/file/d/174yZRYZs3Dc1hYHjiuN6E69ilbi3-07I/view?usp=sharing)                                                                                   |
efficientnetv2_rw_m | 90    | (244, 244) | 0.7461            | 0.7862               | -             | [Ссылка](https://drive.google.com/file/d/1HcI9pHPS0yZnYx8KcGKrUnTsEMvKRmp_/view?usp=sharing) |
swin_base_patch4_window7_224 | 50    | (224, 224) | 0.9885        | 0.9409           | 0.93602       | [Ссылка](https://drive.google.com/file/d/1Gj4JUHmtsaqzE9yP4e_VwoA4zd65CAyU/view?usp=sharing) |
swin_large_patch4_window12_384_in22k | 50    | (384, 384) | 0.9703        | 0.9708           | 0.95402       | [Ссылка](https://drive.google.com/file/d/1CsPxe-HHolQq65o_58M8JNqZj1-gKW9B/view?usp=sharing) |

# Описание экспериментов

1. Обучение `resnet50` на 70% обучающего набора изображений. Размер изображений 224, 224. Количество эпох 90. 
 **Результат**: Train F1 Score:0.7362, Valid F1 Score: 0.7789

2. Обучение `resnet101` на 70% обучающего набора изображений. Размер изображений 224, 224. Количество эпох 90. 
Результат: Train F1 Score:0.7668, Valid F1 Score: 0.7803

3. Обучение `swin_base_patch4_window7_224` на 70% обучающего набора изображений. Размер изображений 224, 224. 
Количество эпох 50. **Результат**: Train F1 Score:0.9240, Valid F1 Score: 0.9266, Test F1 Score: 0.92738 

4. Обучение `swin_large_patch4_window12_384_in22k` на 99.99% обучающего набора изображений 
с понимежнием lr путем умножения на 0.8 каждые 2 эпохи. Размер изображений 384, 384. 
Количество эпох не засек. **Результат**: Train F1 Score:0.9703, Valid F1 Score: 0.9708, Test F1 Score: 0.95361 

5. Обучение `swin_large_patch4_window12_384_in22k` на 70% обучающего набора изображений 
с понимежнием lr путем умножения на 0.8 каждые 2 эпохи. Размер изображений 384, 384. 
Количество эпох не засек. **Результат**: Train F1 Score:0.9652, Valid F1 Score: 0.9537, Test F1 Score: 0.95124 
6. Попытка обработать мусор убрав картинки, ошибочно принадлежащие данному классу. 
Для этого извлекал из каждого изображения фичи, использую предобученную модель `swin_base_patch4_window7_224` 
без слоя классификатора (скрипт для запуска `src/feature_extractor.py`). 
Далее с помощью `IsolationForest` искал выбросы (скрипт для запуска `src/clearing_dataset.py`). 
**Результат**: Визуальный осмотр показал что в мусор попало очень много хороших картинок и мало мусора.
**Предложение по исправлению**: Как вариант использовать DBScan с тонкой настройкой 
параметров для улучшения кластеризации. 
7. Обучение `efficientnetv2_rw_m` на 70% обучающего набора изображений. Размер изображений 224, 224. 
Количество эпох: 90. **Результат**: Train F1 Score: 0.7461, Valid F1 Score: 0.7862, Test F1 Score: -
8. Обучение `swin_large_patch4_window12_384_in22k` на 70% обучающего набора изображений. Размер изображений 224, 224. 
Количество эпох: 90. **Результат**: Train F1 Score: 0.9703, Valid F1 Score: 0.9708, Test F1 Score: 0.95402

